/*
  This class has been generated by the Code Generator
*/

package com.bms.workflow;

import java.util.ArrayList;
import java.util.List;

import org.apache.commons.lang3.StringUtils;

import com.cordys.cpc.bsf.busobject.BSF;
import com.cordys.cpc.bsf.busobject.BusObjectConfig;
import com.cordys.cpc.bsf.busobject.BusObjectIterator;
import com.cordys.cpc.bsf.query.Cursor;
import com.eibus.xml.nom.Document;
import com.eibus.xml.nom.Node;
import com.eibus.xml.xpath.XPath;

public class MSIG_BMS_VIEW extends MSIG_BMS_VIEWBase {
	public MSIG_BMS_VIEW() {
		this((BusObjectConfig) null);
	}

	public MSIG_BMS_VIEW(BusObjectConfig config) {
		super(config);
	}
	
	public void onInsert() {
	}

	public void onUpdate() {
	}

	public void onDelete() {
	}

	private static Document doc = BSF.getXMLDocument();
	
	public static BusObjectIterator<?> fetchBMSRecords(int searchDefinition, int sortDefinition, String formName,
			String view, Cursor cursor) throws MSIG_BMS_EXCEPTION {

		if (StringUtils.isBlank(formName)) {
			throw new MSIG_BMS_EXCEPTION("Invalid Form Name.");
		}
		List<String> searchCriteriaColumns = new ArrayList<String>();

		// Fetch view definition from database
		int viewDefinition = fetchViewDefinition(formName);

		if (viewDefinition == 0) {
			throw new MSIG_BMS_EXCEPTION("Invalid Request.");
		}

		int[] isearchFieldNodes = XPath.getMatchingNodes(".//criteria", null, searchDefinition);

		if (isearchFieldNodes.length > 0 && isearchFieldNodes != null) {
			// Fetch search Filters from view Definition
			searchCriteriaColumns = fetchSearchCriteriaColumns(viewDefinition);
			// Validate the search filters passed from UI
			validateSearchCriteria(isearchFieldNodes, searchCriteriaColumns);
		}
		return MSIG_BMS_APP.fetchCases(viewDefinition, searchDefinition, sortDefinition, formName, view, cursor);
	}

	/**
	 * This method is to fetch the view definition for CMS screens from database
	 * 
	 * @param node
	 * @return veiwDefinition
	 * @throws MSIG_BMS_EXCEPTION
	 */
	public static int fetchViewDefinition(String formName) throws MSIG_BMS_EXCEPTION {
		String errorMessage = "Error occured while fetching database configuration.";
		MSIG_PROPERTIES propObject = null;
		try {
			String viewName;
			propObject = MSIG_PROPERTIES.getMsigPropertiesObject("BMS_VIEW_CONFIG");
			int[] viewDefinition = XPath.getMatchingNodes(".//reportView", null, doc.parseString(propObject.getVALUE()));
			for (int node : viewDefinition) {
				viewName = Node.getAttribute(node, "id");
				if (StringUtils.equalsIgnoreCase(formName, viewName)) {
					return node;
				}
			}
			return 0;
		} catch (Exception e) {
			throw new MSIG_BMS_EXCEPTION(errorMessage);
		}
	}

	/**
	 * This method is used to fetch the search criteria columns for filter
	 * validation
	 * 
	 * @param viewDefinition
	 * @return
	 */
	public static List<String> fetchSearchCriteriaColumns(int viewDefinition) {
		XPath oXpath = XPath.getXPathInstance(".//field");
		String searchField = "";
		List<String> searchCriteriaColumn = new ArrayList<String>();
		int[] fields = oXpath.selectElementNodes(viewDefinition);
		for (int field : fields) {
			searchField = Node.getAttribute(field, "searchFilter");
			if (StringUtils.isNotBlank(searchField)) {
				searchCriteriaColumn.add(searchField);
			}
		}
		return searchCriteriaColumn;
	}

	/**
	 * This method is used to validate the search filter passed from UI against the
	 * search filters in view Definition
	 * 
	 * @param isearchFieldNodes
	 * @param columnList
	 * @throws MSIG_BMS_EXCEPTION
	 */
	private static void validateSearchCriteria(int[] isearchFieldNodes, List<String> columnList)
			throws MSIG_BMS_EXCEPTION {
		String columnName = null;
		String operand = null;
		if (isearchFieldNodes.length > 0 && isearchFieldNodes != null) {
			boolean validColumnName = false, validOperand = false;
			for (int a : isearchFieldNodes) {
				columnName = Node.getData(XPath.getFirstMatch(".//name", null, a));
				operand = Node.getData(XPath.getFirstMatch(".//operand", null, a));
				if (StringUtils.isNotBlank(columnName) && columnList.contains(columnName)) {
					validColumnName = true;
				} else {
					validColumnName = false;
				}
				if (StringUtils.isNotBlank(operand)
						&& StringUtils.isNotBlank(MSIG_BMS_UTILS.operatorMap.get(operand))) {
					validOperand = true;
				} else {
					validOperand = false;
				}
			}

			if (!validColumnName) {
				throw new MSIG_BMS_EXCEPTION("Invalid column Name.");
			}

			if (!validOperand) {
				throw new MSIG_BMS_EXCEPTION("Invalid Operand");
			}
		}
	}

	/**
	 * This is a web service method used to check if user has Head Office Role
	 * 
	 * @return
	 */
	public static boolean isHOUser(String application) {
		List<String> targets = MSIG_BMS_UTILS.getListOfRoleDNs(application);
		boolean isHOUser = false;
		for (String target : targets) {
			if (StringUtils.contains(target, "cn=HO_")) {
				isHOUser = true;
				break;
			}
		}
		return isHOUser;
	}

}
